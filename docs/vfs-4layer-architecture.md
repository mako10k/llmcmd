# VFS 4層アーキテクチャ設計書

## 概要

llmcmdプロジェクトにおけるVFS（Virtual File System）の統一設計として、4層アーキテクチャを採用する。

## アーキテクチャ図

```
┌─────────────────────┐  ┌─────────────────────┐
│  VFSクライアント     │  │  VFSクライアント     │
│    (LLMCMD用)       │  │    (LLMSH用)        │
│                     │  │                     │
│  - QUOTA管理        │  │  - LLM_CHAT IF      │
│  - 継承: LLMSH機能  │  │  - OS互換IF         │
└─────────────────────┘  └─────────────────────┘
           │                        │
           └────────────┬───────────┘
                        │
              ┌─────────────────────┐
              │    VFSプロキシ       │
              │                     │
              │  - リクエスト転送    │
              │  - 結果受け渡し      │
              └─────────────────────┘
                        │
              ┌─────────────────────┐
              │    VFSサーバ        │
              │                     │
              │  - ファイル実体管理  │
              │  - アクセス許可制御  │
              │  - セキュリティ処理  │
              └─────────────────────┘
```

## 各層の責任

### 1. VFSサーバ（内部実装）
- **責任**: ファイルアクセス許可管理、実ファイル・仮想ファイルの実際の操作処理
- **特徴**: 内部構造は自由に設計可能
- **主要メソッド**:
  - `AllowRealFile(name string)` - 実ファイルアクセス許可
  - `OpenFileWithContext(name, flag, perm, isInternal)` - 内部実装
  - `RegisterRealFile(name, flag, perm)` - 実ファイル登録
- **セキュリティ**: 全てのアクセス制御をここで実装

### 2. VFSプロキシ（内部実装）
- **責任**: サーバとクライアント間の仲介役
- **特徴**: 内部実装なので構造は比較的自由
- **機能**: リクエストの転送や結果の受け渡し

### 3. VFSクライアント（LLMSH用）
- **責任**: OS互換のファイル操作インターフェース提供
- **特徴**: 
  - `os.File`に似た標準的なインターフェース
  - LLM_CHAT用のインターフェース追加
  - 設計ミスを防ぐため標準的なパターンに準拠
- **インターフェース**:
```go
type VFSClient struct {
    isInternal bool
    server     *VFSServer
}

func NewVFSClient(server *VFSServer, isInternal bool) *VFSClient
func (c *VFSClient) OpenFile(name string, flag int, perm os.FileMode) (io.ReadWriteCloser, error)
```

### 4. VFSクライアント（LLMCMD用）
- **責任**: LLMSH用クライアントの機能を継承 + QUOTA管理
- **特徴**: LLMSH用クライアントを拡張
- **追加機能**: QUOTA管理などの追加インターフェース
- **インターフェース**:
```go
type LLMCMDVFSClient struct {
    *VFSClient // LLMSH用クライアントを埋め込み
    quota      *QuotaManager
}

func NewLLMCMDVFSClient(server *VFSServer, isInternal bool) *LLMCMDVFSClient
func (c *LLMCMDVFSClient) UpdateQuota(bytes int64)
```

## 重要な設計決定

### 1. 文脈情報の管理
- `isInternal`などの文脈情報はクライアントコンストラクタで渡す
- クライアント側では毎回コンテキスト情報を渡す必要なし
- サーバ側で`OpenFileWithContext`を使った内部処理

### 2. インターフェース設計
- **クライアント側**: 標準的な`OpenFile`インターフェースのみ使用
- **サーバ側**: `OpenFileWithContext`で内部処理を隠蔽
- **セキュリティ**: `AllowRealFile`はサーバ内部メソッドとして隠蔽

### 3. アクセス制御
- **初期化**: コマンドラインオプションからファイル名を受け取る
- **許可リスト**: VFSの初期化時にこれらのファイル名を渡す
- **統一インターフェース**: コマンドからは単純に`OpenFile`などを呼び出すだけ
- **隠蔽**: 許可チェックはVFS内部で完全に隠蔽する

## 実装手順

1. **Phase 1**: 現在のVirtualFSをVFSサーバとして分離
2. **Phase 2**: VFSプロキシの実装
3. **Phase 3**: VFSクライアント(LLMSH用)の実装
4. **Phase 4**: VFSクライアント(LLMCMD用)の実装
5. **Phase 5**: 既存コードの移行とテスト

## 現在の問題と解決策

### 問題
- 既存のVirtualFSが混在した責任を持っている
- OpenFileWithContextがクライアントに露出している
- 4層構造への分離が必要

### 解決策
1. 責任の明確な分離
2. クライアント側は標準的なインターフェースのみ
3. サーバ側で内部実装詳細を隠蔽
4. セキュリティ制御の一元化

## メリット

1. **保守性**: 各層の責任が明確
2. **セキュリティ**: アクセス制御が一元化
3. **互換性**: OS標準インターフェースとの互換性
4. **拡張性**: 各用途に応じたクライアントの実装
5. **テスタビリティ**: 各層の独立したテスト

## 設計原則

1. **単一責任**: 各層は明確な責任を持つ
2. **依存性逆転**: クライアントはインターフェースに依存
3. **情報隠蔽**: 内部実装詳細は隠蔽
4. **標準準拠**: OS標準インターフェースとの互換性
5. **セキュリティファースト**: アクセス制御を一元化
